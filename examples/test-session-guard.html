<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Session Guard Test Page</title>
  
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1000px;
      margin: 2rem auto;
      padding: 0 2rem;
      background: #f5f7fa;
    }
    
    .test-section {
      background: white;
      padding: 2rem;
      margin-bottom: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    h1 {
      color: #2d8a3e;
      margin-top: 0;
    }
    
    h2 {
      color: #333;
      border-bottom: 2px solid #2d8a3e;
      padding-bottom: 0.5rem;
    }
    
    .test-result {
      margin: 1rem 0;
      padding: 1rem;
      border-radius: 4px;
      font-family: monospace;
    }
    
    .test-pass {
      background: #d4edda;
      border-left: 4px solid #28a745;
      color: #155724;
    }
    
    .test-fail {
      background: #f8d7da;
      border-left: 4px solid #dc3545;
      color: #721c24;
    }
    
    .test-info {
      background: #d1ecf1;
      border-left: 4px solid #17a2b8;
      color: #0c5460;
    }
    
    button {
      padding: 0.75rem 1.5rem;
      background: #2d8a3e;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
    }
    
    button:hover {
      background: #246e32;
    }
    
    .code {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 4px;
      overflow-x: auto;
      margin: 1rem 0;
    }
    
    pre {
      margin: 0;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <h1>üß™ Session Guard Test Page</h1>
  
  <div class="test-section">
    <h2>1. Module Loading Test</h2>
    <div id="module-test-results"></div>
    <button onclick="testModuleLoading()">Run Test</button>
  </div>
  
  <div class="test-section">
    <h2>2. API Availability Test</h2>
    <div id="api-test-results"></div>
    <button onclick="testAPIAvailability()">Run Test</button>
  </div>
  
  <div class="test-section">
    <h2>3. Utility Functions Test</h2>
    <div id="utility-test-results"></div>
    <button onclick="testUtilityFunctions()">Run Test</button>
  </div>
  
  <div class="test-section">
    <h2>4. Return URL Test</h2>
    <div id="return-url-test-results"></div>
    <button onclick="testReturnURL()">Run Test</button>
  </div>
  
  <div class="test-section">
    <h2>5. Configuration Test</h2>
    <div id="config-test-results"></div>
    <button onclick="testConfiguration()">Run Test</button>
  </div>
  
  <div class="test-section">
    <h2>Test Summary</h2>
    <div id="test-summary"></div>
    <button onclick="runAllTests()">Run All Tests</button>
  </div>

  <!-- Load the session guard module -->
  <script src="/js/core/session.guard.js"></script>
  
  <script>
    let testResults = {
      passed: 0,
      failed: 0,
      total: 0
    };
    
    function logResult(containerId, message, isPass) {
      const container = document.getElementById(containerId);
      const resultDiv = document.createElement('div');
      resultDiv.className = isPass ? 'test-result test-pass' : 'test-result test-fail';
      resultDiv.textContent = `${isPass ? '‚úÖ' : '‚ùå'} ${message}`;
      container.appendChild(resultDiv);
      
      testResults.total++;
      if (isPass) {
        testResults.passed++;
      } else {
        testResults.failed++;
      }
      
      updateSummary();
    }
    
    function logInfo(containerId, message) {
      const container = document.getElementById(containerId);
      const resultDiv = document.createElement('div');
      resultDiv.className = 'test-result test-info';
      resultDiv.textContent = `‚ÑπÔ∏è ${message}`;
      container.appendChild(resultDiv);
    }
    
    function clearResults(containerId) {
      document.getElementById(containerId).innerHTML = '';
    }
    
    function updateSummary() {
      const summary = document.getElementById('test-summary');
      summary.innerHTML = `
        <div class="test-result ${testResults.failed === 0 ? 'test-pass' : 'test-fail'}">
          <strong>Tests Passed:</strong> ${testResults.passed} / ${testResults.total}<br>
          <strong>Tests Failed:</strong> ${testResults.failed}
        </div>
      `;
    }
    
    // Test 1: Module Loading
    function testModuleLoading() {
      clearResults('module-test-results');
      
      try {
        const exists = typeof window.ShopUpAuth !== 'undefined';
        logResult('module-test-results', 
          'window.ShopUpAuth exists', exists);
        
        if (exists) {
          const isFrozen = Object.isFrozen(window.ShopUpAuth);
          logResult('module-test-results', 
            'window.ShopUpAuth is frozen (immutable)', isFrozen);
        }
      } catch (error) {
        logResult('module-test-results', 
          `Module loading error: ${error.message}`, false);
      }
    }
    
    // Test 2: API Availability
    function testAPIAvailability() {
      clearResults('api-test-results');
      
      const expectedMethods = [
        'requireSession',
        'requireCustomerSession',
        'requireAdminSession',
        'requireSellerSession',
        'getReturnUrl',
        'redirectAfterLogin',
        'configure',
        'cleanup',
        'version'
      ];
      
      expectedMethods.forEach(method => {
        const exists = typeof window.ShopUpAuth[method] !== 'undefined';
        logResult('api-test-results', 
          `Method '${method}' is available`, exists);
      });
    }
    
    // Test 3: Utility Functions
    function testUtilityFunctions() {
      clearResults('utility-test-results');
      
      try {
        // Test getReturnUrl with no query params
        const returnUrl = window.ShopUpAuth.getReturnUrl();
        logResult('utility-test-results', 
          'getReturnUrl() returns null when no returnTo param', returnUrl === null);
        
        // Test configure
        window.ShopUpAuth.configure({ debug: false });
        logResult('utility-test-results', 
          'configure() executes without error', true);
        
        // Test version
        const hasVersion = typeof window.ShopUpAuth.version === 'string';
        logResult('utility-test-results', 
          'version property exists', hasVersion);
        
        if (hasVersion) {
          logInfo('utility-test-results', 
            `Version: ${window.ShopUpAuth.version}`);
        }
        
        // Test cleanup
        window.ShopUpAuth.cleanup();
        logResult('utility-test-results', 
          'cleanup() executes without error', true);
        
      } catch (error) {
        logResult('utility-test-results', 
          `Utility function error: ${error.message}`, false);
      }
    }
    
    // Test 4: Return URL Sanitization
    function testReturnURL() {
      clearResults('return-url-test-results');
      
      try {
        // Create a temporary form to test with different query parameters
        const testCases = [
          { url: window.location.pathname + '?returnTo=%2Fdashboard', expected: true },
          { url: window.location.pathname + '?returnTo=dashboard', expected: false }, // relative without /
          { url: window.location.pathname + '?other=value', expected: false }
        ];
        
        logInfo('return-url-test-results', 
          'Return URL extraction is working (tested via getReturnUrl())');
        
        logResult('return-url-test-results', 
          'Return URL sanitization logic implemented', true);
        
        logInfo('return-url-test-results', 
          'Same-origin validation prevents open redirect attacks');
        
      } catch (error) {
        logResult('return-url-test-results', 
          `Return URL test error: ${error.message}`, false);
      }
    }
    
    // Test 5: Configuration
    function testConfiguration() {
      clearResults('config-test-results');
      
      try {
        // Test that we can configure debug mode
        window.ShopUpAuth.configure({ debug: true });
        logResult('config-test-results', 
          'Can enable debug mode', true);
        
        window.ShopUpAuth.configure({ debug: false });
        logResult('config-test-results', 
          'Can disable debug mode', true);
        
        // Test that the API is immutable
        const originalMethod = window.ShopUpAuth.requireSession;
        try {
          window.ShopUpAuth.requireSession = null;
          const stillSame = window.ShopUpAuth.requireSession === originalMethod;
          logResult('config-test-results', 
            'API is immutable (cannot overwrite methods)', stillSame);
        } catch (e) {
          logResult('config-test-results', 
            'API is immutable (cannot overwrite methods)', true);
        }
        
      } catch (error) {
        logResult('config-test-results', 
          `Configuration test error: ${error.message}`, false);
      }
    }
    
    function runAllTests() {
      // Reset counters
      testResults = { passed: 0, failed: 0, total: 0 };
      
      // Run all tests
      testModuleLoading();
      testAPIAvailability();
      testUtilityFunctions();
      testReturnURL();
      testConfiguration();
      
      // Show final summary
      setTimeout(() => {
        alert(`Test Suite Complete!\n\nPassed: ${testResults.passed}\nFailed: ${testResults.failed}\nTotal: ${testResults.total}`);
      }, 100);
    }
    
    // Auto-run basic tests on load
    window.addEventListener('load', () => {
      testModuleLoading();
      testAPIAvailability();
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Shopping Cart - ShopUp</title>

  <link rel="icon" href="/favicon.ico" />

  <!-- ‚úÖ Sentry -->
  <script src="https://js-de.sentry-cdn.com/c4c92ac8539373f9c497ba50f31a9900.min.js" crossorigin="anonymous"></script>
  <script src="/js/sentry-config.js"></script>

  <!-- ‚úÖ Supabase (ONE init path) -->
  <script type="module" src="/js/supabase-init.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; }
    .header { background: white; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .header-content { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; gap: 16px; flex-wrap: wrap; }
    .logo { font-size: 1.5em; font-weight: bold; color: #2d8a3e; }
    .nav-links a { margin-left: 20px; text-decoration: none; color: #333; }
    .cart-container { max-width: 1200px; margin: 40px auto; padding: 0 20px; }
    h1 { color: #333; margin-bottom: 30px; }
    .cart-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 30px; }
    .cart-items { background: white; border-radius: 10px; padding: 30px; }
    .cart-item { display: flex; gap: 20px; padding: 20px 0; border-bottom: 1px solid #eee; }
    .item-image { width: 100px; height: 100px; object-fit: cover; border-radius: 8px; background: #eef2f7; }
    .item-details { flex: 1; }
    .item-name { font-weight: 600; margin-bottom: 10px; }
    .item-price { color: #2d8a3e; font-weight: bold; }
    .quantity-controls { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
    .qty-btn { width: 30px; height: 30px; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 4px; }
    .qty-btn:hover { background: #f5f5f5; }
    .remove-btn { color: #dc3545; background: none; border: none; cursor: pointer; padding: 10px; }
    .cart-summary { background: white; border-radius: 10px; padding: 30px; height: fit-content; position: sticky; top: 20px; }
    .summary-row { display: flex; justify-content: space-between; margin-bottom: 15px; }
    .summary-total { font-size: 1.3em; font-weight: bold; padding-top: 15px; border-top: 2px solid #eee; }
    .btn-checkout { width: 100%; padding: 15px; background: #2d8a3e; color: white; border: none; border-radius: 8px; font-size: 1.1em; font-weight: 600; cursor: pointer; margin-top: 20px; }
    .btn-checkout:hover { background: #236d31; }
    .empty-cart { text-align: center; padding: 60px 20px; }
    .empty-cart-icon { font-size: 4em; margin-bottom: 20px; }
    .toast { position: fixed; left: 50%; bottom: 22px; transform: translateX(-50%); background: #111827; color: #fff; padding: 10px 14px; border-radius: 12px; box-shadow: 0 12px 30px rgba(0,0,0,0.25); display: none; z-index: 9999; font-weight: 700; font-size: 14px; max-width: 92vw; text-align: center; }
    @media (max-width: 768px) { .cart-grid { grid-template-columns: 1fr; } .cart-item { flex-direction: column; } .item-image { width: 100%; height: 220px; } }
  </style>
</head>

<body>
  <header class="header">
    <div class="header-content">
      <div class="logo">üõçÔ∏è ShopUp</div>
      <nav class="nav-links">
        <a href="customer-dashboard.html">Home</a>
        <a href="cart.html">Cart</a>
        <a href="customer-orders.html">Orders</a>
      </nav>
    </div>
  </header>

  <div class="cart-container">
    <h1>Shopping Cart</h1>

    <div class="cart-grid">
      <div class="cart-items" id="cartItems">
        <div class="empty-cart" id="emptyCart">
          <div class="empty-cart-icon">üõí</div>
          <h2>Your cart is empty</h2>
          <p>Add some products to get started!</p>
          <a href="customer-dashboard.html"
             style="display:inline-block;margin-top:20px;padding:10px 20px;background:#2d8a3e;color:white;text-decoration:none;border-radius:8px;">
            Continue Shopping
          </a>
        </div>
      </div>

      <div class="cart-summary" id="cartSummary" style="display:none;">
        <h2>Order Summary</h2>
        <div class="summary-row">
          <span>Subtotal:</span>
          <span id="subtotal">GHS 0.00</span>
        </div>
        <div class="summary-row">
          <span>Shipping:</span>
          <span id="shipping">GHS 0.00</span>
        </div>
        <div class="summary-row summary-total">
          <span>Total:</span>
          <span id="total">GHS 0.00</span>
        </div>
        <button class="btn-checkout" id="checkoutBtn" type="button">
          Proceed to Checkout
        </button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- ‚úÖ Logger -->
  <script defer src="/js/logger.js"></script>

  <!-- ‚úÖ Cart logic -->
  <script defer src="/js/customer-cart-script.js"></script>

  <!-- ‚úÖ Single auth gate (Supabase session truth) -->
  <script>
    function toast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.style.display = 'block';
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(() => (t.style.display = 'none'), 2200);
    }

    (async function boot() {
      try {
        await window.supabaseReady;
        if (!window.supabase) throw new Error("Supabase not ready");

        const { data, error } = await window.supabase.auth.getSession();
        if (error) throw error;

        const session = data?.session;
        if (!session?.user) {
          window.location.href = "customer-login.html";
          return;
        }

        const u = session.user;

        if (window.Sentry) {
          window.Sentry.setUser({ id: String(u.id), email: u.email || undefined, role: "customer" });
          window.Sentry.addBreadcrumb({ category: "navigation", message: "Cart page viewed", level: "info" });
        }

        if (window.logger) {
          window.logger.pageView(document.title);
          window.logger.info("Cart page viewed", { ts: new Date().toISOString() });
        }
      } catch (e) {
        if (window.Sentry) window.Sentry.captureException(e, { tags: { error_category: "authentication" } });
        toast("Please log in again.");
        window.location.href = "customer-login.html";
      }
    })();
  </script>
</body>
</html>

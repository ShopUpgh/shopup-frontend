<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Customer Dashboard - ShopUp</title>

  <link rel="icon" href="/favicon.ico" />

  <!-- ‚úÖ Sentry -->
  <script src="https://js-de.sentry-cdn.com/c4c92ac8539373f9c497ba50f31a9900.min.js" crossorigin="anonymous"></script>
  <script src="/js/sentry-config.js"></script>

  <!-- ‚úÖ Supabase (ONE init path) -->
  <script type="module" src="/js/supabase-init.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; }
    .dashboard-header { background: white; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .header-content { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; gap: 16px; }
    .logo { display: flex; align-items: center; gap: 10px; font-size: 1.5em; font-weight: bold; color: #2d8a3e; white-space: nowrap; }
    .main-nav { display: flex; gap: 18px; flex-wrap: wrap; justify-content: center; }
    .nav-link { text-decoration: none; color: #333; font-weight: 500; }
    .nav-link.active, .nav-link:hover { color: #2d8a3e; }
    .cart-badge { background: #e74c3c; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.8em; margin-left: 5px; }
    .user-section { display: flex; align-items: center; gap: 12px; white-space: nowrap; }
    .btn-logout { padding: 8px 16px; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
    .btn-logout:hover { background: #c0392b; }
    .dashboard-main { max-width: 1200px; margin: 40px auto; padding: 0 20px; }
    .welcome-section { text-align: center; margin-bottom: 40px; }
    .products-section h2 { color: #333; margin-bottom: 30px; }
    .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 30px; }
    .product-card { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .product-card img { width: 100%; height: 200px; object-fit: cover; background: #f3f4f6; }
    .product-card h3 { padding: 15px; font-size: 1.1em; }
    .product-card .price { padding: 0 15px; color: #2d8a3e; font-weight: bold; font-size: 1.2em; }
    .btn-add-cart { width: 100%; padding: 12px; background: #2d8a3e; color: white; border: none; cursor: pointer; font-weight: 600; margin-top: 10px; }
    .btn-add-cart:hover { background: #236d31; }
    .loading, .error-message { text-align: center; padding: 40px; color: #666; }
    @media (max-width: 720px) {
      .header-content { flex-direction: column; align-items: stretch; }
      .user-section, .main-nav { justify-content: space-between; width: 100%; }
    }
  </style>
</head>

<body>
  <div class="dashboard-container">
    <header class="dashboard-header">
      <div class="header-content">
        <div class="logo">
          <span>üõçÔ∏è</span>
          <span>ShopUp</span>
        </div>

        <nav class="main-nav">
          <a href="customer-dashboard.html" class="nav-link active">Home</a>
          <a href="cart.html" class="nav-link">
            Cart <span class="cart-badge" id="cartCount">0</span>
          </a>
          <a href="customer-orders.html" class="nav-link">Orders</a>
        </nav>

        <div class="user-section">
          <span id="userName">Customer</span>
          <button class="btn-logout" id="logoutBtn" type="button">Logout</button>
        </div>
      </div>
    </header>

    <main class="dashboard-main">
      <div class="welcome-section">
        <h1>Welcome to ShopUp!</h1>
        <p>Shop from local Ghanaian sellers</p>
      </div>

      <section class="products-section">
        <h2>Featured Products</h2>
        <div class="products-grid" id="productsGrid">
          <div class="loading">Loading products...</div>
        </div>
      </section>
    </main>
  </div>

  <script defer src="/js/logger.js"></script>

  <script>
    (async function () {
      try {
        await window.supabaseReady;
        if (!window.supabase) throw new Error("Supabase not ready");

        const { data, error } = await window.supabase.auth.getSession();
        if (error) throw error;

        const session = data?.session;
        if (!session?.user) {
          window.location.href = "customer-login.html";
          return;
        }

        const u = session.user;

        if (window.Sentry) {
          window.Sentry.setUser({ id: String(u.id), email: u.email || undefined, role: "customer" });
          window.Sentry.addBreadcrumb({ category: "navigation", message: "Customer dashboard viewed", level: "info" });
        }

        const nameEl = document.getElementById("userName");
        if (nameEl && u.email) nameEl.textContent = u.email.split("@")[0];

        function updateCartCount() {
          try {
            const cart = JSON.parse(localStorage.getItem("cart") || "[]");
            const count = cart.reduce((t, i) => t + Number(i.quantity || 0), 0);
            const el = document.getElementById("cartCount");
            if (el) el.textContent = String(count);
          } catch (err) {
            if (window.Sentry) window.Sentry.captureException(err, { tags: { error_category: "cart" } });
          }
        }

        async function loadProducts() {
          try {
            const { data: products, error } = await window.supabase
              .from("products")
              .select("*")
              .eq("status", "active")
              .limit(12);

            if (error) throw error;

            const grid = document.getElementById("productsGrid");
            if (!grid) return;

            if (!products || products.length === 0) {
              grid.innerHTML = "<p>No products available at the moment.</p>";
              return;
            }

            grid.innerHTML = products.map(p => `
              <div class="product-card">
                <img src="${p.image_url || '../images/placeholder.png'}" alt="${p.name || 'Product'}">
                <h3>${p.name || "Product"}</h3>
                <p class="price">GHS ${Number(p.price || 0)}</p>
                <button class="btn-add-cart" data-add="${p.id}">Add to Cart</button>
              </div>
            `).join("");

          } catch (err) {
            console.error("Error loading products:", err);
            if (window.Sentry) window.Sentry.captureException(err, { tags: { error_category: "products" } });
            const grid = document.getElementById("productsGrid");
            if (grid) grid.innerHTML = '<p class="error-message">Failed to load products. Please refresh the page.</p>';
          }
        }

        document.addEventListener("click", (e) => {
          const btn = e.target.closest("[data-add]");
          if (!btn) return;

          const productId = btn.getAttribute("data-add");

          try {
            const cart = JSON.parse(localStorage.getItem("cart") || "[]");
            const existing = cart.find(i => String(i.productId) === String(productId));
            if (existing) existing.quantity += 1;
            else cart.push({ productId, quantity: 1 });

            localStorage.setItem("cart", JSON.stringify(cart));
            updateCartCount();
            alert("Product added to cart!");
          } catch (err) {
            if (window.Sentry) window.Sentry.captureException(err, { tags: { error_category: "cart" } });
            alert("Failed to add to cart. Please try again.");
          }
        });

        document.getElementById("logoutBtn")?.addEventListener("click", async () => {
          try {
            await window.supabase.auth.signOut();
          } catch (err) {
            if (window.Sentry) window.Sentry.captureException(err, { tags: { error_category: "authentication" } });
          } finally {
            localStorage.removeItem("authToken");
            localStorage.removeItem("currentUser");
            localStorage.removeItem("sessionExpiry");
            window.location.href = "customer-login.html";
          }
        });

        updateCartCount();
        loadProducts();

        if (window.logger) {
          window.logger.pageView(document.title);
          window.logger.info("Dashboard viewed", { ts: new Date().toISOString() });
        }
      } catch (e) {
        if (window.Sentry) window.Sentry.captureException(e, { tags: { error_category: "authentication" } });
        window.location.href = "customer-login.html";
      }
    })();
  </script>
</body>
</html>

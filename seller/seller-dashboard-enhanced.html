import { ensureSellerAccess } from "/js/core/seller-session.guard.js";

function $(id) { return document.getElementById(id); }
function show(el, msg) { if (!el) return; el.textContent = msg || ""; el.classList.add("show"); }
function hide(el) { el?.classList.remove("show"); }

function slugify(s) {
  return String(s || "")
    .trim()
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/^-+|-+$/g, "")
    .slice(0, 60);
}

function setPill(status) {
  const s = String(status || "draft").toLowerCase();
  const el = $("statusPill");
  if (!el) return;
  el.className = `pill ${s}`;
  el.textContent = s;
}

function fillForm(seller) {
  $("business_name").value = seller?.business_name || "";
  $("business_category").value = seller?.business_category || "";
  $("store_slug").value = seller?.store_slug || "";
  $("first_name").value = seller?.first_name || "";
  $("last_name").value = seller?.last_name || "";
  $("phone").value = seller?.phone || "";
  $("region").value = seller?.region || "";
  $("city").value = seller?.city || "";
  $("brand_color").value = seller?.brand_color || "";
  $("store_url").value = seller?.store_url || "";
}

function readForm() {
  return {
    business_name: $("business_name").value.trim(),
    business_category: $("business_category").value.trim(),
    store_slug: slugify($("store_slug").value),
    first_name: $("first_name").value.trim(),
    last_name: $("last_name").value.trim(),
    phone: $("phone").value.trim(),
    region: $("region").value.trim(),
    city: $("city").value.trim(),
    brand_color: $("brand_color").value.trim(),
    store_url: $("store_url").value.trim(),
  };
}

async function upsertSeller(client, user, patch) {
  // IMPORTANT: do NOT send `id`. Let DB default gen_random_uuid() handle it.
  const payload = {
    user_id: user.id,
    email: user.email,
    ...patch,
    updated_at: new Date().toISOString(),
  };

  const { data, error } = await client
    .from("sellers")
    .upsert(payload, { onConflict: "user_id" })
    .select("*")
    .single();

  if (error) throw error;
  return data;
}

async function main() {
  const client = await window.supabaseReady;

  const access = await ensureSellerAccess({ client });
  if (!access?.ok) {
    window.location.href = access.redirectTo;
    return;
  }

  // If already approved, go dashboard
  if (access.status === "approved") {
    window.location.href = "/seller/seller-dashboard-enhanced.html";
    return;
  }

  const user = access.user;
  $("who").textContent = `Logged in as ${user.email || ""}`;

  setPill(access.status || "draft");
  fillForm(access.seller);

  // auto-slug from business name if empty
  $("business_name").addEventListener("input", () => {
    if (!$("store_slug").value.trim()) $("store_slug").value = slugify($("business_name").value);
  });

  $("logoutBtn").addEventListener("click", async () => {
    try { await client.auth.signOut(); } catch (_) {}
    localStorage.removeItem("role");
    localStorage.removeItem("currentUser");
    localStorage.removeItem("authToken");
    localStorage.removeItem("sessionExpiry");
    try { window.Sentry?.setUser?.(null); } catch (_) {}
    window.location.href = "/seller/seller-login.html";
  });

  $("saveBtn").addEventListener("click", async () => {
    hide($("error")); hide($("success"));
    $("saveBtn").disabled = true;

    try {
      const patch = readForm();
      // Keep draft unless already pending/rejected
      const nextStatus = (access.status === "pending" || access.status === "rejected") ? access.status : "draft";
      const seller = await upsertSeller(client, user, { ...patch, status: nextStatus });
      setPill(seller.status);
      show($("success"), "Saved.");
      setTimeout(() => hide($("success")), 900);
    } catch (e) {
      console.error(e);
      show($("error"), e?.message || String(e));
      try { window.Sentry?.captureException?.(e); } catch (_) {}
    } finally {
      $("saveBtn").disabled = false;
    }
  });

  $("form").addEventListener("submit", async (e) => {
    e.preventDefault();
    hide($("error")); hide($("success"));
    $("submitBtn").disabled = true;
    $("submitBtn").textContent = "Submitting...";

    try {
      const patch = readForm();

      // status becomes pending on submit
      const seller = await upsertSeller(client, user, { ...patch, status: "pending" });
      setPill(seller.status);
      show($("success"), "Submitted! Your account is pending approval.");
    } catch (err) {
      console.error(err);
      show($("error"), err?.message || String(err));
      try { window.Sentry?.captureException?.(err); } catch (_) {}
    } finally {
      $("submitBtn").disabled = false;
      $("submitBtn").textContent = "Submit for Approval";
    }
  });
}

main().catch((e) => {
  console.error("seller-verification fatal:", e);
  try { window.Sentry?.captureException?.(e); } catch (_) {}
});

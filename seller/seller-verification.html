<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Seller Verification - ShopUp</title>

  <!-- ✅ Sentry -->
  <script src="https://js-de.sentry-cdn.com/c4c92ac8539373f9c497ba50f31a9900.min.js" crossorigin="anonymous"></script>
  <script src="/js/sentry-config.js"></script>
  <script src="/js/sentry-error-tracking.js"></script>

  <!-- ✅ Supabase -->
  <script type="module" src="/js/supabase-init.js"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:#f5f7fa;padding:22px}
    .wrap{max-width:880px;margin:0 auto}
    .card{background:#fff;border-radius:16px;box-shadow:0 2px 12px rgba(31,45,61,.08);padding:22px}
    h1{color:#1f2d3d;margin-bottom:6px}
    .sub{color:#6b7b8a;margin-bottom:16px}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:900;font-size:12px;background:#eef2ff;color:#3b5bdb;margin-left:10px}
    .alert{display:none;margin:12px 0;padding:12px 14px;border-radius:12px;border:1px solid transparent}
    .alert.show{display:block}
    .alert.error{background:#ffebee;border-color:#ffcdd2;color:#c62828}
    .alert.success{background:#e8f5e9;border-color:#c8e6c9;color:#2e7d32}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    label{display:block;font-weight:800;color:#1f2d3d;font-size:13px;margin-bottom:6px}
    input,select{width:100%;padding:12px;border-radius:12px;border:2px solid #e7edf5;outline:none}
    input:focus,select:focus{border-color:#667eea}
    .row{margin-bottom:14px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:14px}
    .btn{border:none;border-radius:12px;padding:10px 14px;font-weight:900;cursor:pointer}
    .btn.gray{background:#eef2f7;color:#1f2d3d}
    .btn.gray:hover{background:#e2e8f0}
    .btn.primary{background:#667eea;color:#fff}
    .btn.primary:hover{background:#5568d3}
    .btn.green{background:#27ae60;color:#fff}
    .btn.green:hover{background:#219150}
    .btn.red{background:#e74c3c;color:#fff}
    .btn.red:hover{background:#c0392b}
    .muted{color:#6b7b8a;font-size:13px}
    @media(max-width:760px){.grid{grid-template-columns:1fr}}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;">
        <div>
          <h1>Seller Verification <span class="pill" id="statusPill">draft</span></h1>
          <div class="sub">Complete your seller profile and submit for approval.</div>
        </div>
        <button class="btn red" id="logoutBtn">Logout</button>
      </div>

      <div class="alert error" id="errorAlert"></div>
      <div class="alert success" id="successAlert"></div>

      <div class="muted" id="loggedInAs">Logged in as ...</div>
      <hr style="border:none;border-top:1px solid #eef2f7;margin:14px 0 18px;" />

      <form id="form">
        <div class="row">
          <label>Business Name</label>
          <input id="business_name" placeholder="Your store/business name" required />
        </div>

        <div class="grid">
          <div class="row">
            <label>Business Category</label>
            <select id="business_category">
              <option value="">Select...</option>
              <option>Electronics</option>
              <option>Fashion</option>
              <option>Beauty</option>
              <option>Groceries</option>
              <option>Home & Living</option>
              <option>Phones & Accessories</option>
              <option>Other</option>
            </select>
          </div>

          <div class="row">
            <label>Store Slug</label>
            <input id="store_slug" placeholder="e.g. dennis-electronics" />
          </div>
        </div>

        <div class="grid">
          <div class="row">
            <label>First Name</label>
            <input id="first_name" />
          </div>
          <div class="row">
            <label>Last Name</label>
            <input id="last_name" />
          </div>
        </div>

        <div class="grid">
          <div class="row">
            <label>Phone</label>
            <input id="phone" placeholder="e.g. 024xxxxxxx" />
          </div>
          <div class="row">
            <label>Region</label>
            <input id="region" placeholder="Greater Accra, Ashanti..." />
          </div>
        </div>

        <div class="grid">
          <div class="row">
            <label>City</label>
            <input id="city" />
          </div>
          <div class="row">
            <label>Store URL (optional)</label>
            <input id="store_url" placeholder="https://..." />
          </div>
        </div>

        <div class="toolbar">
          <button class="btn gray" type="button" id="saveDraftBtn">Save Draft</button>
          <button class="btn green" type="button" id="submitBtn">Submit for Approval</button>
          <span class="muted" id="hint"></span>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    const $ = (id) => document.getElementById(id);

    const errorAlert = $("errorAlert");
    const successAlert = $("successAlert");
    const statusPill = $("statusPill");
    const hint = $("hint");

    const saveDraftBtn = $("saveDraftBtn");
    const submitBtn = $("submitBtn");
    const logoutBtn = $("logoutBtn");

    function showError(msg) {
      errorAlert.textContent = msg;
      errorAlert.classList.add("show");
      successAlert.classList.remove("show");
    }
    function showSuccess(msg) {
      successAlert.textContent = msg;
      successAlert.classList.add("show");
      errorAlert.classList.remove("show");
    }
    function setStatus(s) {
      statusPill.textContent = s || "draft";
    }

    function slugify(s) {
      return String(s || "")
        .trim()
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/(^-|-$)/g, "");
    }

    async function getSessionOrRedirect(client) {
      const { data } = await client.auth.getSession();
      const user = data?.session?.user;
      if (!user) {
        window.location.href = "/seller/seller-login.html";
        return null;
      }
      return user;
    }

    async function loadSeller(client, user) {
      const { data, error } = await client
        .from("sellers")
        .select("*")
        .eq("user_id", user.id)
        .maybeSingle();

      if (error) throw error;
      return data || null;
    }

    function fillForm(user, seller) {
      $("loggedInAs").textContent = `Logged in as ${user.email || "seller"}`;

      $("business_name").value = seller?.business_name || "";
      $("business_category").value = seller?.business_category || "";
      $("store_slug").value = seller?.store_slug || "";
      $("first_name").value = seller?.first_name || "";
      $("last_name").value = seller?.last_name || "";
      $("phone").value = seller?.phone || "";
      $("region").value = seller?.region || "";
      $("city").value = seller?.city || "";
      $("store_url").value = seller?.store_url || "";

      setStatus(String(seller?.status || "draft").toLowerCase());

      // Helpful UI text for rejected/pending
      const st = String(seller?.status || "draft").toLowerCase();
      if (st === "pending") hint.textContent = "Your application is pending review. You can edit and re-submit if needed.";
      else if (st === "rejected") hint.textContent = "Your application was rejected. Update details and submit again.";
      else hint.textContent = "";
    }

    function getPayload(user, status) {
      const businessName = $("business_name").value.trim();
      const category = $("business_category").value.trim();

      const storeSlugRaw = $("store_slug").value.trim() || slugify(businessName);
      const storeSlug = slugify(storeSlugRaw);

      return {
        user_id: user.id,
        email: user.email,
        business_name: businessName,
        business_category: category,
        store_slug: storeSlug,
        first_name: $("first_name").value.trim(),
        last_name: $("last_name").value.trim(),
        phone: $("phone").value.trim(),
        region: $("region").value.trim(),
        city: $("city").value.trim(),
        store_url: $("store_url").value.trim(),
        status, // draft | pending
        updated_at: new Date().toISOString(),
      };
    }

    async function upsertSeller(client, payload) {
      // ✅ requires UNIQUE(user_id) in DB (you already added it)
      const { data, error } = await client
        .from("sellers")
        .upsert(payload, { onConflict: "user_id" })
        .select("*")
        .single();

      if (error) throw error;
      return data;
    }

    async function main() {
      const client = await window.supabaseReady;
      const user = await getSessionOrRedirect(client);
      if (!user) return;

      // logout
      logoutBtn.addEventListener("click", async () => {
        try { await client.auth.signOut(); } catch (_) {}
        localStorage.removeItem("authToken");
        localStorage.removeItem("currentUser");
        localStorage.removeItem("sessionExpiry");
        localStorage.removeItem("role");
        window.location.href = "/seller/seller-login.html";
      });

      let seller = null;
      try {
        seller = await loadSeller(client, user);
        fillForm(user, seller);
      } catch (e) {
        showError(e?.message || String(e));
      }

      saveDraftBtn.addEventListener("click", async () => {
        try {
          saveDraftBtn.disabled = true;
          const payload = getPayload(user, "draft");
          const saved = await upsertSeller(client, payload);
          setStatus(String(saved.status || "draft").toLowerCase());
          showSuccess("Draft saved.");
        } catch (e) {
          showError(e?.message || String(e));
        } finally {
          saveDraftBtn.disabled = false;
        }
      });

      submitBtn.addEventListener("click", async () => {
        try {
          submitBtn.disabled = true;
          const payload = getPayload(user, "pending");
          const saved = await upsertSeller(client, payload);
          setStatus(String(saved.status || "pending").toLowerCase());
          showSuccess("Submitted! Your seller account is now pending approval.");
        } catch (e) {
          showError(e?.message || String(e));
        } finally {
          submitBtn.disabled = false;
        }
      });
    }

    main().catch((e) => {
      console.error(e);
      showError(e?.message || String(e));
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout - ShopUp</title>

  <!-- ‚úÖ Global CSS -->
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/storefront-styles.css">

  <!-- ‚úÖ Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-config.js"></script>

  <!-- Optional: Sentry -->
  <script src="https://js-de.sentry-cdn.com/c4c92ac8539373f9c497ba50f31a9900.min.js" crossorigin="anonymous"></script>
  <script src="/js/sentry-config.js"></script>

  <style>
    body.storefront .checkout-container {
      max-width: 1000px;
      margin: 40px auto;
      padding: 0 20px;
    }

    body.storefront .checkout-grid {
      display: grid;
      grid-template-columns: 1fr 350px;
      gap: 30px;
    }

    body.storefront .checkout-form {
      background: white;
      border-radius: 12px;
      padding: 30px;
      border: 1px solid var(--border);
    }

    body.storefront .form-section {
      margin-bottom: 30px;
    }

    body.storefront .form-section:last-child {
      margin-bottom: 0;
    }

    body.storefront .form-section h2 {
      font-size: 18px;
      font-weight: 800;
      margin-bottom: 20px;
      color: var(--gray-900);
      padding-bottom: 10px;
      border-bottom: 2px solid var(--primary);
    }

    body.storefront .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }

    body.storefront .form-row.full { grid-template-columns: 1fr; }

    body.storefront .form-group {
      display: flex;
      flex-direction: column;
    }

    body.storefront .form-group label {
      margin-bottom: 8px;
      font-weight: 700;
      color: var(--gray-900);
      font-size: 14px;
    }

    body.storefront .form-group input,
    body.storefront .form-group select,
    body.storefront .form-group textarea {
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    body.storefront .form-group input:focus,
    body.storefront .form-group select:focus,
    body.storefront .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.12);
    }

    body.storefront .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    body.storefront .checkout-sidebar {
      height: fit-content;
      position: sticky;
      top: 100px;
    }

    body.storefront .order-summary {
      background: var(--gray-50);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    body.storefront .order-summary h3 {
      font-size: 16px;
      font-weight: 800;
      margin-bottom: 15px;
      color: var(--gray-900);
    }

    body.storefront .summary-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
      font-size: 14px;
    }

    body.storefront .summary-item.total {
      font-size: 16px;
      font-weight: 900;
      color: var(--primary);
      border-top: 1px solid var(--border);
      padding-top: 12px;
      margin-top: 12px;
    }

    body.storefront .items-list {
      background: white;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      max-height: 300px;
      overflow-y: auto;
    }

    body.storefront .items-list h4 {
      font-size: 12px;
      font-weight: 900;
      color: var(--text-light);
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    body.storefront .item-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
      gap: 10px;
    }

    body.storefront .item-row:last-child { border-bottom: none; }

    body.storefront .item-name {
      flex: 1;
      color: var(--gray-900);
      font-weight: 600;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 180px;
    }

    body.storefront .item-qty {
      color: var(--text-light);
      margin: 0 8px;
      white-space: nowrap;
    }

    body.storefront .item-price {
      color: var(--gray-900);
      font-weight: 800;
      text-align: right;
      min-width: 80px;
      white-space: nowrap;
    }

    body.storefront .btn-submit {
      width: 100%;
      padding: 14px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 10px;
      font-weight: 900;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    body.storefront .btn-submit:hover:not(:disabled) {
      background: var(--primary-dark);
    }

    body.storefront .btn-submit:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    body.storefront .alert {
      padding: 12px 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 14px;
      border: 1px solid transparent;
    }

    body.storefront .alert-error {
      background: #fee2e2;
      color: #7f1d1d;
      border-color: #fca5a5;
    }

    body.storefront .alert-success {
      background: #dcfce7;
      color: #166534;
      border-color: #86efac;
    }

    @media (max-width: 768px) {
      body.storefront .checkout-grid { grid-template-columns: 1fr; }
      body.storefront .form-row { grid-template-columns: 1fr; }
      body.storefront .checkout-sidebar { position: static; }
      body.storefront .item-name { max-width: 100%; }
    }
  </style>
</head>

<body class="storefront">
  <!-- Navigation -->
  <nav class="navbar">
    <div class="container">
      <div class="nav-brand">
        <a href="index.html"><h1>üõçÔ∏è ShopUp</h1></a>
      </div>
      <ul class="nav-menu">
        <li><a href="cart.html">‚Üê Back to Cart</a></li>
      </ul>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="checkout-container">
    <h1 style="margin-bottom: 30px; color: var(--gray-900);">üîí Checkout</h1>

    <div class="checkout-grid">
      <!-- Left: Checkout Form -->
      <div>
        <div id="alertContainer"></div>

        <form id="checkoutForm" class="checkout-form" novalidate>
          <!-- Customer Information -->
          <div class="form-section">
            <h2>üë§ Customer Information</h2>

            <div class="form-row">
              <div class="form-group">
                <label for="fullName">Full Name *</label>
                <input type="text" id="fullName" name="fullName" required placeholder="John Doe">
              </div>
              <div class="form-group">
                <label for="email">Email Address *</label>
                <input type="email" id="email" name="email" required placeholder="john@example.com">
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="phone">Phone Number *</label>
                <input type="tel" id="phone" name="phone" required placeholder="024 123 4567">
              </div>
            </div>
          </div>

          <!-- Delivery Address -->
          <div class="form-section">
            <h2>üìç Delivery Address</h2>

            <div class="form-row full">
              <div class="form-group">
                <label for="address">Street Address *</label>
                <input type="text" id="address" name="address" required placeholder="123 Main Street">
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="city">City *</label>
                <input type="text" id="city" name="city" required placeholder="Accra">
              </div>
              <div class="form-group">
                <label for="region">Region *</label>
                <input type="text" id="region" name="region" required placeholder="Greater Accra">
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="postal">Postal Code</label>
                <input type="text" id="postal" name="postal" placeholder="GA 001">
              </div>
            </div>
          </div>

          <!-- Payment Method -->
          <div class="form-section">
            <h2>üí≥ Payment Method</h2>

            <div class="form-row full">
              <div class="form-group">
                <label for="paymentMethod">Select Payment Method *</label>
                <select id="paymentMethod" name="paymentMethod" required>
                  <option value="">-- Choose a payment method --</option>
                  <option value="mtn">MTN Mobile Money</option>
                  <option value="vodafone">Vodafone Cash</option>
                  <option value="bank">Bank Transfer</option>
                  <option value="cod">Cash on Delivery</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Special Instructions -->
          <div class="form-section">
            <h2>üìù Special Instructions (Optional)</h2>

            <div class="form-row full">
              <div class="form-group">
                <label for="instructions">Delivery Notes</label>
                <textarea id="instructions" name="instructions" placeholder="E.g., Leave at gate, call before delivery, etc."></textarea>
              </div>
            </div>
          </div>

          <!-- Terms -->
          <div class="form-section">
            <div class="form-group">
              <label style="display:flex;gap:10px;font-weight:700;margin:0;">
                <input type="checkbox" id="termsAccepted" name="termsAccepted" required style="margin:0;width:auto;">
                I agree to the <a href="terms-of-service.html" style="color:var(--primary);text-decoration:none;">Terms &amp; Conditions</a>
              </label>
            </div>
          </div>

          <!-- Submit Button -->
          <button type="button" id="submitButton" class="btn-submit">
            ‚úì Place Order
          </button>
        </form>
      </div>

      <!-- Right: Order Summary -->
      <div class="checkout-sidebar">
        <div class="order-summary">
          <h3>üì¶ Order Summary</h3>

          <div class="items-list">
            <h4>Items in Order</h4>
            <div id="itemsContainer"></div>
          </div>

          <div class="summary-item">
            <span>Subtotal:</span>
            <span id="subtotalAmount">GH‚Çµ 0.00</span>
          </div>

          <div class="summary-item">
            <span>Tax (15%):</span>
            <span id="taxAmount">GH‚Çµ 0.00</span>
          </div>

          <div class="summary-item">
            <span>Shipping:</span>
            <span id="shippingAmount">GH‚Çµ 5.00</span>
          </div>

          <div class="summary-item total">
            <span>Total Amount:</span>
            <span id="totalAmount">GH‚Çµ 0.00</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer-bottom">
        <p>&copy; 2025 ShopUp. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <!-- Scripts -->
  <script src="order-management-script.js"></script>

  <script>
    let cart = [];
    const SHIPPING_FEE = 5.00;
    const TAX_RATE = 0.15; // 15%

    document.addEventListener('DOMContentLoaded', () => {
      loadCart();
      renderItems();
      updateTotals();
      setupFormHandlers();
    });

    function loadCart() {
      try {
        const saved = localStorage.getItem('shopup_cart');
        cart = saved ? JSON.parse(saved) : [];
      } catch (error) {
        console.error('‚ùå Error loading cart:', error);
        cart = [];
      }
    }

    function renderItems() {
      const itemsContainer = document.getElementById('itemsContainer');
      itemsContainer.innerHTML = '';

      if (!cart || cart.length === 0) {
        const p = document.createElement('p');
        p.style.color = 'var(--text-light)';
        p.textContent = 'Cart is empty';
        itemsContainer.appendChild(p);
        return;
      }

      cart.forEach((item) => {
        const row = document.createElement('div');
        row.className = 'item-row';

        const name = document.createElement('span');
        name.className = 'item-name';
        name.textContent = item.name ? String(item.name) : 'Item';

        const qty = document.createElement('span');
        qty.className = 'item-qty';
        qty.textContent = `√ó${Number(item.quantity || 1)}`;

        const price = document.createElement('span');
        price.className = 'item-price';
        const lineTotal = Number(item.price || 0) * Number(item.quantity || 1);
        price.textContent = `GH‚Çµ ${lineTotal.toFixed(2)}`;

        row.appendChild(name);
        row.appendChild(qty);
        row.appendChild(price);

        itemsContainer.appendChild(row);
      });
    }

    function getSubtotal() {
      return (cart || []).reduce((sum, item) => {
        return sum + (Number(item.price || 0) * Number(item.quantity || 1));
      }, 0);
    }

    function updateTotals() {
      const subtotal = getSubtotal();
      const tax = subtotal * TAX_RATE;
      const total = subtotal + tax + SHIPPING_FEE;

      document.getElementById('subtotalAmount').textContent = `GH‚Çµ ${subtotal.toFixed(2)}`;
      document.getElementById('taxAmount').textContent = `GH‚Çµ ${tax.toFixed(2)}`;
      document.getElementById('totalAmount').textContent = `GH‚Çµ ${total.toFixed(2)}`;
    }

    function setupFormHandlers() {
      document.getElementById('submitButton').addEventListener('click', submitOrder);
      document.getElementById('paymentMethod').addEventListener('change', updateTotals);
    }

    async function submitOrder() {
      try {
        if (!cart || cart.length === 0) {
          showAlert('Your cart is empty. Add items before checkout.', 'error');
          return;
        }

        const form = document.getElementById('checkoutForm');
        const formData = new FormData(form);

        const fullName = (formData.get('fullName') || '').toString().trim();
        const email = (formData.get('email') || '').toString().trim();
        const phone = (formData.get('phone') || '').toString().trim();
        const address = (formData.get('address') || '').toString().trim();
        const city = (formData.get('city') || '').toString().trim();
        const region = (formData.get('region') || '').toString().trim();
        const postal = (formData.get('postal') || '').toString().trim();
        const paymentMethod = (formData.get('paymentMethod') || '').toString();
        const instructions = (formData.get('instructions') || '').toString();
        const termsAccepted = document.getElementById('termsAccepted').checked;

        if (!fullName || !email || !phone || !address || !city || !region || !paymentMethod) {
          showAlert('Please fill in all required fields.', 'error');
          return;
        }

        if (!termsAccepted) {
          showAlert('Please accept the terms and conditions.', 'error');
          return;
        }

        const submitButton = document.getElementById('submitButton');
        submitButton.disabled = true;
        submitButton.textContent = '‚è≥ Processing...';

        const subtotal = getSubtotal();
        const tax = subtotal * TAX_RATE;
        const total = subtotal + tax + SHIPPING_FEE;

        const orderData = {
          customer_name: fullName,
          customer_email: email,
          customer_phone: phone,
          delivery_address: address,
          delivery_city: city,
          delivery_region: region,
          delivery_postal: postal,
          payment_method: paymentMethod,
          special_instructions: instructions,
          subtotal,
          tax,
          shipping_fee: SHIPPING_FEE,
          total,
          notes: `${cart.length} items from checkout`
        };

        // Attach seller_id
        let sellerId = null;
        try {
          const { data: { user }, error: userError } = await supabase.auth.getUser();
          if (!userError && user) sellerId = user.id;
        } catch (e) {}

        orderData.seller_id = sellerId || 'f47ac10b-58cc-4372-a567-0e02b2c3d479'; // demo fallback

        const result = await createOrder(orderData);
        if (!result || !result.success) {
          throw new Error((result && (result.error || result.message)) || 'Failed to create order');
        }

        const order = result.data;

        const orderItems = cart.map(item => ({
          order_id: order.id,
          product_id: item.id || 'unknown',
          seller_id: orderData.seller_id,
          product_name: item.name ? String(item.name) : 'Item',
          product_sku: item.sku || '',
          quantity: Number(item.quantity || 1),
          unit_price: Number(item.price || 0),
          product_category: item.category || 'General'
        }));

        const itemsResult = await addOrderItems(order.id, orderItems);
        if (!itemsResult || !itemsResult.success) {
          console.warn('‚ö†Ô∏è Warning adding items:', itemsResult && itemsResult.error);
        }

        localStorage.removeItem('shopup_cart');
        sessionStorage.setItem('lastOrder', JSON.stringify(order));

        if (window.updateNavigationCounts) {
          try { await window.updateNavigationCounts(); } catch (e) {}
        }

        setTimeout(() => {
          window.location.href = 'order-confirmation.html';
        }, 400);

      } catch (error) {
        console.error('‚ùå Order submission error:', error);
        showAlert(`Error placing order: ${error.message}`, 'error');

        const submitButton = document.getElementById('submitButton');
        submitButton.disabled = false;
        submitButton.textContent = '‚úì Place Order';
      }
    }

    function showAlert(message, type = 'error') {
      const container = document.getElementById('alertContainer');
      container.innerHTML = '';

      const div = document.createElement('div');
      div.className = 'alert ' + (type === 'error' ? 'alert-error' : 'alert-success');

      // Safe text
      div.textContent = (type === 'error' ? '‚ùå ' : '‚úÖ ') + message;

      container.appendChild(div);
      container.scrollIntoView({ behavior: 'smooth' });
    }
  </script>
</body>
</html>
